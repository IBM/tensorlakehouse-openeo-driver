from typing import Any, Dict, List
from openeo_geodn_driver.catalog import GeoDNCollectionCatalog
import pytest
import pandas as pd
from openeo_geodn_driver.constants import STAC_URL
from openeo_geodn_driver.tests.unit.unit_test_util import validate_OpenEO_collection
from openeo_geodn_driver.stac import STAC

COLLECTION_ID_ERA5 = "Global weather (ERA5)"


@pytest.fixture(scope="module")
def catalog():
    return GeoDNCollectionCatalog()


@pytest.mark.parametrize(
    "catalog, collection_id",
    [
        ("catalog", "HLSS30"),
        ("catalog", "HLSL30"),
        ("catalog", "Global weather (ERA5)"),
    ],
    indirect=["catalog"],
)
def test_get_collection_metadata(catalog, collection_id: str):
    stac = STAC(STAC_URL)
    if stac.is_collection_available(collection_id=collection_id):
        collection = catalog.get_collection_metadata(collection_id=collection_id)
        assert isinstance(collection, dict)
        assert all(f in collection.keys() for f in ["cube:dimensions"])
        validate_OpenEO_collection(collection=collection)
    else:
        pytest.skip(f"Warning! {collection_id} collection is not available")


@pytest.mark.parametrize(
    "catalog",
    ["catalog"],
    indirect=["catalog"],
)
def test_get_all_metadata(catalog: GeoDNCollectionCatalog):
    collections = catalog.get_all_metadata()
    for collection in collections:
        assert isinstance(collection, dict)
        validate_OpenEO_collection(collection=collection)


@pytest.mark.parametrize(
    "collection_id, params, catalog",
    [
        (COLLECTION_ID_ERA5, {"max_items": 10}, "catalog"),
        (COLLECTION_ID_ERA5, {"max_items": 10, "bbox": [-91, 40, -90, 41]}, "catalog"),
        ("HLSS30", {"max_items": 10}, "catalog"),
        ("HLSL30", {"max_items": 10}, "catalog"),
    ],
    indirect=["catalog"],
)
def test_get_collection_items(
    collection_id: str, params: Dict[str, Any], catalog: GeoDNCollectionCatalog
):
    stac = STAC(STAC_URL)
<<<<<<< HEAD
    collections = stac.list_collections()
    for c in collections["collections"]:
        collection_id = c["id"]
        feature_collection = catalog.get_collection_items(
            collection_id=collection_id, parameters=None
=======
    if stac.is_collection_available(collection_id=collection_id):
        feature_collection = catalog.get_collection_items(
            collection_id=collection_id, parameters=params
>>>>>>> main
        )
        assert isinstance(feature_collection, dict)
        items: List[Dict[str, Any]] = feature_collection["features"]
        assert len(items) > 0
        for item in items:
            properties = item.get("properties")
            assert isinstance(properties, dict), f"not a dict {properties}"
            assert all(
                f in properties.keys() for f in ["cube:dimensions", "cube:variables"]
            ), f"Error! {collection_id} is invalid! {properties}"
            assert (
                properties.get("datetime") is not None
                or properties.get("start_datetime") is not None
            )
<<<<<<< HEAD
            if properties.get("datetime") is not None:
                dt_str = properties.get("datetime")
                assert isinstance(dt_str, str), f"Error! not a str {dt_str}"
                # this must not raise an exception
                pd.Timestamp(dt_str)
            else:
                start_datetime_str = properties.get("start_datetime")
                assert isinstance(
                    start_datetime_str, str
                ), f"Error! not a str {start_datetime_str}"
                pd.Timestamp(start_datetime_str)
=======
            datetime = properties.get("datetime")
            assert isinstance(datetime, str), f"Error! not a str {datetime}"
            pd.Timestamp(datetime)
    else:
        pytest.skip(f"Warning! {collection_id} collection is not available")
>>>>>>> main
